‚óè ‚úÖ Implementation Complete - Stage 1 & 2

  I've successfully implemented the critical fixes for VishwaSetu AI voice. Here's what was done:

  Stage 1: Backend Dual-Mode Support ‚úÖ

  1. PCM Passthrough Mode (backend/src/routes/classroom.ts:151-182)
  - Added dual-mode audio handling:
    - format === 'pcm' ‚Üí Direct passthrough (no FFmpeg)
    - format === 'm4a'/'caf' ‚Üí FFmpeg conversion (fallback)
  - Added PCM validation (alignment, size checks)
  - Enhanced logging with emojis for easy tracking

  2. Enhanced Debug Logging (backend/src/services/geminiLiveService.ts:48-54)
  - Added detailed logging when Gemini sends audio chunks
  - Shows base64 length and estimated PCM bytes
  - Easier to verify Gemini is actually responding

  3. SSE Broadcasting (Already Working)
  - Verified the onEvent callback broadcasts all events generically
  - audioChunk events will automatically reach frontend

  4. PCM Validation Utility (backend/src/services/audioUtils.ts:136-158)
  - New validatePcm16() function
  - Checks: 16-bit alignment, minimum size, silence detection
  - Provides clear error messages for debugging

  Stage 2: Frontend 16kHz Recording ‚úÖ

  5. Gemini-Optimized Recording Preset (hooks/useClassroom.ts:1-50)
  - Created GEMINI_RECORDING_PRESET with:
    - Sample rate: 16kHz (matches Gemini's expected input)
    - Channels: Mono
    - Format: M4A/AAC (platform-native)
  - Platform-specific configurations for Android/iOS/Web
  - Should reduce file sizes by ~30%
  - Eliminates resampling corruption (the main issue)

  ---
  üß™ Testing Instructions

  Now you need to test the implementation:

  1. Restart the Backend

  cd backend
  npm run dev

  2. Restart the Frontend

  npm start

  3. Test the Live Classroom

  1. Open the app and navigate to the Classroom screen
  2. Start a session and speak into the microphone
  3. Watch the backend logs carefully

  4. Expected Backend Log Output

  Before (Broken):
  [SESSION xxx] Received 10784 bytes of m4a audio
  [AUDIO] Converting 10784 bytes from m4a to PCM...
  [AUDIO] Conversion finished. Output size: 20062 bytes
  üì• [BACKEND] Message from Gemini: {"setupComplete":{}}...
  (NO AUDIO, NO TRANSCRIPTS)

  After (Fixed):
  [SESSION xxx] Received 8000 bytes of m4a audio  ‚Üê Smaller files!
  [AUDIO] Converting 8000 bytes from m4a to PCM...
  [AUDIO] Conversion finished. Output size: 19200 bytes
  üì• [BACKEND] Message from Gemini: {"setupComplete":{}}...
  üì• [BACKEND] Message from Gemini: {"serverContent":{"inputTranscription":...
  üîä [BACKEND] Gemini audio chunk received: 15000 base64 chars (~11250 bytes PCM)  ‚Üê NEW!
  [BACKEND] Broadcasting SSE event: audioChunk  ‚Üê NEW!
  üì• [BACKEND] Message from Gemini: {"serverContent":{"outputTranscription":...

  5. Expected Frontend Log Output

  Look for these new logs:
  LOG [FRONTEND] Event [audioChunk]: {"audioData":"...","mimeType":"audio/pcm;rate=24000"}
  LOG [FRONTEND] PCM buffer size: 15360 bytes - triggering playback
  LOG [FRONTEND] Converting PCM to WAV...
  LOG [FRONTEND] Playing audio file: file:///.../vishwa-audio-123456.wav

  6. Success Criteria

  ‚úÖ PRIMARY GOAL: You hear Vishwa speaking back (AI voice)
  ‚úÖ Backend logs show üîä Gemini audio chunk received
  ‚úÖ Frontend logs show Event [audioChunk] and Playing audio file
  ‚úÖ Both input and output transcripts appear
  ‚úÖ Smaller M4A file sizes (~8KB vs ~11KB per chunk)

  ---
  üö® If It Still Doesn't Work

  If Gemini is still silent after this:

  1. Check file sizes: Are M4A chunks smaller now (~8KB instead of ~11KB)?
    - If YES ‚Üí 16kHz recording is working
    - If NO ‚Üí expo-audio might not support 16kHz (rare)
  2. Check FFmpeg output: Look for the conversion quality in logs
    - The conversion should be faster and produce consistent ~19-20KB PCM
  3. Manual PCM test: Try sending a synthetic 16kHz PCM file via Postman to test backend dual-mode

  Let me know what you see in the logs, and we can troubleshoot from there!